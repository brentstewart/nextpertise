<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Zerotier on </title>
    <link>https://www.nextpertise.net/tags/zerotier/</link>
    <description>Recent content in Zerotier on </description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Tue, 27 Oct 2020 22:10:59 -0400</lastBuildDate>
    
        <atom:link href="https://www.nextpertise.net/tags/zerotier/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>ZeroTier Router</title>
      <link>https://www.nextpertise.net/posts/201027_zerotierrouter/</link>
      <pubDate>Tue, 27 Oct 2020 22:10:59 -0400</pubDate>
      
      <guid>https://www.nextpertise.net/posts/201027_zerotierrouter/</guid>
      <description>&lt;p&gt;This article continues the exploration of ZeroTier started in a previous &lt;a href=&#34;https://www.nextpertise.net/zerotier&#34;&gt;posting&lt;/a&gt;.  The first article described zerotier - an overlay virtual wire that hangs on the internet to connect disparate clients into a psuedo local network.  At the end of the discussion, we had a PC at home and a 4G mobile phone talking over Zerotier.&lt;/p&gt;
&lt;p&gt;I&amp;rsquo;ll continue the thought describing how to connect your local home network to your Zerotier virtual network.  For purposes of this article, let&amp;rsquo;s consider a home network with a little complexity.
&lt;img src=&#34;https://www.nextpertise.net/ZeroTier_Routing.png#center&#34; alt=&#34;Sample Network&#34;&gt;&lt;/p&gt;
&lt;p&gt;In this example, there is a base network of 192.168.100.0/24.  The 101 network is routed through the firewall and is used for IoT devices, while 102 is used for wireless.  104/22 has a next-hop in GNS3, so that a network can be establish and ennumberated using the network simulator and still route out to the &amp;ldquo;real&amp;rdquo; world.&lt;/p&gt;
&lt;p&gt;We want to create a router that has one interface in the local 192.168.100.0/24 network and a virtual interface in the virtual Zerotier 103.0/24 network, able to route between them.  To do this, I built a new Linux server (an Ubuntu 20.10 VM, but any distro physical or virtual should work).  I named the router &amp;ldquo;ZTRouter&amp;rdquo;.&lt;/p&gt;
&lt;p&gt;A quick note - use care when routing 192.168.0.0/24 and 192.168.1.0/24.  A lot of home routers use these ranges and adding a ZeroTier route to the same destination might lead to confusion.  Select a space out of 10/8, 172.16/12, or 192.168/16 that won&amp;rsquo;t conflict with other routes you need to support.&lt;/p&gt;
&lt;h2 id=&#34;zerotier-routing&#34;&gt;ZeroTier Routing&lt;/h2&gt;
&lt;p&gt;I assigned ZTRouter 192.168.100.2/24 with a default route to the local router at 192.168.100.1.  Next I installed Zerotier and attached it to the SDN built in the last article.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;curl -s https://install.zerotier.com | sudo bash  
sudo zerotier-cli join 0123456789ABCDEF
sudo zerotier-cli listnetworks
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://www.nextpertise.net/ZTrouting.png#floatright&#34; alt=&#34;Zero Tier Routing Configuration&#34;&gt;The router will be automatically assigned an address on the ZeroTier network - in this case I received 192.168.103.88.  &lt;strong&gt;listnetworks&lt;/strong&gt; is used to confirm the connection.&lt;/p&gt;
&lt;p&gt;The routing that will need to be setup might not be obvious, so let&amp;rsquo;s walk through each route.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;192.168.103.0/24 is the Zerotier network.  A range from this network should be used in &amp;ldquo;auto-assign pools&amp;rdquo; in ZeroTier Central, such as 192.168.103.1 - 192.168.103.50.&lt;/li&gt;
&lt;li&gt;192.168.100.0/22 is the summary route to the local network and it points to ZTRouter.  This tells the other ZeroTier clients that this range is available through ZTRouter.&lt;/li&gt;
&lt;li&gt;192.168.104.0/22 is another summary route, this time for GNS3.  Again, this communicates the availability of the range to the ZeroTier network via ZTRouter.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;routing-between-zerotier-and-the-lan&#34;&gt;Routing between ZeroTier and the LAN&lt;/h2&gt;
&lt;p&gt;Next, ZTRouter needs to be enabled as a router.  Edit /etc/sysctl.conf and uncomment the line that says &lt;strong&gt;net.ipv4.forward&lt;/strong&gt;.  This will enable the Linux machine to route when it reboots.  Since we want it to work &lt;em&gt;now&lt;/em&gt;, well use this command as well:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo sysctl -w net.ipv4.ip_forward&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The local firewall also has to permit the traffic.  Depending on the distro, you may have nftables, iptables, or ufw.  Assuming the system uses iptables, start by getting the interface names.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;ip link
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;For purposes of the article, let&amp;rsquo;s assume it shows you that the ethernet is enp1s0 and ZeroTier is zt1&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;PHY_IFACE&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;enp1s0; ZT_IFACE&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;zt1 
sudo iptables -t nat -A POSTROUTING -o $PHY_IFACE -j MASQUERADE  
sudo iptables -A FORWARD -i $PHY_IFACE -o $ZT_IFACE -m state --state RELATED,ESTABLISHED -j ACCEPT  
sudo iptables -A FORWARD -i $ZT_IFACE -o $PHY_IFACE -j ACCEPT  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Make the iptables changes persistent.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo apt install iptables-persistent
sudo bash -c iptables-save &amp;gt; /etc/iptables/rules.v4
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;reciprocal-routes&#34;&gt;Reciprocal Routes&lt;/h2&gt;
&lt;p&gt;If testing is done at this point, it will show that ZT clients can ping the LAN interface of ZTRouter but can&amp;rsquo;t reach other users on the LAN.  What gives?  The problem is that we&amp;rsquo;ve built a path from the ZT cloud into our LAN, but not the reciprocal path &lt;em&gt;back&lt;/em&gt;.  The local users have a default gateway of the Internet router and &lt;em&gt;it&lt;/em&gt; doesn&amp;rsquo;t have a route to 192.168.103.0/24.  The easy way to fix that is to give it a route.  Everyone&amp;rsquo;s home router will be different, so in psuedo-code you just need to &lt;strong&gt;route 192.168.103.0/24 via 192.168.100.2&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Testing will now show that ZeroTier clients can ping devices in the &amp;ldquo;100&amp;rdquo; network!  But, they can&amp;rsquo;t reach the other local VLANs.  The problem is that ZTRouter doesn&amp;rsquo;t have a route.  To fix that, add a summary route going to the Internet router.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;ip route add 192.168.100.0/22 gw 192.168.100.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Add this line to &lt;em&gt;/etc/rc.local&lt;/em&gt; so that it is persistent.&lt;/p&gt;
&lt;p&gt;Note that this summary includes the ZeroTier network.  The routing table prefers the most specific path, so traffic to 103/24 will continue to route to ZeroTier and everything else will take the less specific route to the inter-vlan router.&lt;/p&gt;
&lt;p&gt;At this point, ZeroTier clients will be able to reach all the local subnets (100/24, 101/24, and 102/24).  Traffic to GNS3 can also be pointed to the Internet router, or it can be directed to a GNS3 router.  Note that 100/22 and 104/22 can&amp;rsquo;t be summarized into 100/21 because they fall across a bit-boundary, so they&amp;rsquo;ll have to be configured as two routes.&lt;/p&gt;
&lt;p&gt;One place that can cause trouble is route selection.  On ZTRouter, the ZeroTier summary route for 100/22 will be in the routing table.  The static route created &lt;em&gt;must&lt;/em&gt; be a lower metric so that it takes precedence.&lt;/p&gt;
&lt;h2 id=&#34;summary&#34;&gt;Summary&lt;/h2&gt;
&lt;p&gt;This is a slick setup.  ZeroTier makes a great VPN client, punches through NATs, and can create sophisticated routing.  The two places I expect folks to get hung up are getting the routes correctly configured in ZeroTier Central and making sure there is a reciprocal route back to the ZeroTier VPN range.  If you have problems, work your way out from the router one step at a time and make sure you understand how the routes are working going in &lt;em&gt;both&lt;/em&gt; directions (I&amp;rsquo;ve taught routing for twenty years and everyone always forgets to check the path back).&lt;/p&gt;
&lt;p&gt;Of course, most networks won&amp;rsquo;t be as sophisticated as the one shown here and will be very straightforward to setup.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>ZeroTier Basic Configuration</title>
      <link>https://www.nextpertise.net/posts/201027_zerotier/</link>
      <pubDate>Sun, 25 Oct 2020 16:29:57 -0400</pubDate>
      
      <guid>https://www.nextpertise.net/posts/201027_zerotier/</guid>
      <description>&lt;p&gt;Zerotier is a virtualized network that runs &amp;ldquo;on top of&amp;rdquo; the Internet.&lt;/p&gt;
&lt;p&gt;Traditional VPN solutions are built around a VPN server, which acts as a hub location with a stable IP.  Modern teams feature mobile workers and home connections with random IPs behind service-provider NATs.  Start-up teams and home users are left with few options, all of which involve some level of compromise.&lt;/p&gt;
&lt;p&gt;Zerotier works around this by offering a stable point to connect end-points.  The connection strategy resembles VoIP connections - there&amp;rsquo;s a registration to a central point, that tries a variety of ways to create a connection to end points.  It then allows the end-points to speak directly.  All traffic between end-points is encrypted peer-to-peer.&lt;/p&gt;
&lt;p&gt;Zerotier allows the creation of a &amp;ldquo;virtual ethernet&amp;rdquo; that connects disparate endpoints.  I created a ZeroTier network and tested it with Fedora and Ubuntu Linux, as well as an Android phone.  I was able to connect to the ZeroTier network from a guest wifi and over a 4G connection.  Once connected, it behaved like a local network.  I was able to SSH, browse and download files, access a Calibre server, and use KDE Connect.&lt;/p&gt;
&lt;h2 id=&#34;setting-up-a-zerotier-network&#34;&gt;Setting up a ZeroTier network&lt;/h2&gt;
&lt;p&gt;Go to &lt;a href=&#34;https://www.zerotier.com&#34;&gt;ZeroTier&lt;/a&gt; and scroll down to the bottom to &lt;strong&gt;Sign Up&lt;/strong&gt;.  After signing up, you&amp;rsquo;ll be taken to the ZeroTier Central page and be given a 16-digit hex network id and a made up name (like &amp;ldquo;gratious_donut&amp;rdquo;).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.nextpertise.net/ZTnetworks.png#floatright&#34; alt=&#34;Zero Tier Networking&#34;&gt;&lt;/p&gt;
&lt;p&gt;Make sure under Access Control that you set your network to private.  This will not allow new connections without your permission.&lt;/p&gt;
&lt;p&gt;Under advanced, choose a network range.  You can use one of the &amp;ldquo;easy&amp;rdquo; options or select an IP address range of your own.  For now, just choose a pre-defined range.&lt;/p&gt;
&lt;p&gt;There&amp;rsquo;s an option to use IPv6.  The easy way is to click the ZeroTier 6PLANE option.  It&amp;rsquo;s a great idea to be learning about IPv6, but most of us are still using v4 and if that&amp;rsquo;s the case for you then just leave this turned off.&lt;/p&gt;
&lt;p&gt;That&amp;rsquo;s it for Central for now.  Copy your network ID (the 16 digit hex number).  We&amp;rsquo;ll need to revisit Central later, but next we need to setup devices.&lt;/p&gt;
&lt;h2 id=&#34;client-installation&#34;&gt;Client installation&lt;/h2&gt;
&lt;p&gt;The instructions  for setting up clients can be found at &lt;a href=&#34;https://www.zerotier.com/download&#34;&gt;ZeroTier Downloads&lt;/a&gt;.  There&amp;rsquo;s a clicky MSI installer for Windows, and a pkg for Mac.  Smartphone users are directed to their stores.&lt;/p&gt;
&lt;p&gt;On Linux, the software can be installed with this command:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;curl -s https://install.zerotier.com | sudo bash  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;After installation, use &lt;strong&gt;zerotier-cli&lt;/strong&gt; to join the new virtual network.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo zerotier-cli join 123456789ABCDEF  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://www.nextpertise.net/ZTclient.png#floatright&#34; alt=&#34;ZeroTier Client&#34;&gt;
Go back to Central and scroll down to clients.  Find the new client and check the Auth? box.  You should add a name and description here as well to help identify this client as you add more endpoints.&lt;/p&gt;
&lt;p&gt;Back at Linux, confirm that you&amp;rsquo;re on the network.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo zerotier-cli status
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Next, let&amp;rsquo;s setup an Android endpoint to have something to talk to.  Grab the app from the Play store.  Click the + in the upper right and type in the network ID.  Slide the ON button over and go back to Central and Authorize the client.&lt;/p&gt;
&lt;p&gt;You can continue to add clients in this manner, but I suggest you pause here.  My next article will be about routing between networks with Zerotier and that may be useful before you move further.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
