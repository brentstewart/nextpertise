<!doctype html>
  <html lang="en">
  <head itemscope itemtype="https://nextpertise.net/">
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-173443199-1');
      </script>
    <title>Nextpertise Proxmox Backup Server - a personal journal of interesting ideas</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://Nextpertise.net/style.css">
    <link rel="icon" href="/n.ico">
    <meta http-equiv="content-type" content="text/html; charset=windows-1252">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-173443199-1"></script>
    


  </head>
  <body>
    <link rel="stylesheet" href="https://nextpertise.net/bootstrap-table.css">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Nextpertise is a journal of interesting ideas: Proxmox Backup Server (PBS) saved my bacon.
Backstory I&rsquo;ve been using Proxmox VE (Virtual Edition) for a couple years and I&rsquo;ve been pretty pleased with it (previous article on using it to run GNS3).">
    <meta name="keywords" content="backup, virtualization, linux,Proxmox Backup" />
    <meta name="twitter:card" content="Incredibly valuable and also free!">
    <meta property="og:title" content="Proxmox Backup Server" >
    <meta property="og:url" content="https://nextpertise.net/posts/240204_pbs/" >
    <meta property="og:description" content="Incredibly valuable and also free!" >
    <meta property="og:image" content="https://nextpertise.net/non-technical.png" >
    <link rel="apple-touch-icon" href="https://nextpertise.net/non-technical.png" >
    <link rel="stylesheet" href="https://nextpertise.net/style.css" >
</head>
<div class="tags"><img src="https://nextpertise.net/nextpertise_rays.png" alt="Nextpertise" height="75" > <i>a journal of interesting technical ideas . . .</i></div>
<div class="nav"style="text-align: left">
  <nav class="sidebar-nav">
    
    
      <a class="sidebar-nav-item" href="/" title="">Home
    
      <a class="sidebar-nav-item" href="/tags/" title="">TagCloud
    
      <a class="sidebar-nav-item" href="/posts/" title="">Archives
    
      <a class="sidebar-nav-item" href="https://stewart.tc/" title="">Personal
    
      <a class="sidebar-nav-item" href="https://stewart.tc/reading/" title="">Reading
    
      <a class="sidebar-nav-item" href="https://github.com/brentstewart" title="">Github
    
      <a class="sidebar-nav-item" href="/links" title="">Links
    
      <a class="sidebar-nav-item" href="/contributors" title="">About
    
    &NonBreakingSpace;Find us on:&NonBreakingSpace;
    <a href="https://nextpertise.net/index.xml"><img src="/Feed-icon.png" alt="RSS" height="25" >
    <a href="https://www.linkedin.com/company/nextpertise"><img src="/linkedin.png" alt="LinkedIn" height="25" >
    
  </div>

    
<img src="/backup.png#floatright" height="140">
<h1>Proxmox Backup Server</h1> 
  <h6><div style="text-align: right"><i>by Brent Stewart  on Sunday, Feb 4, 2024</i><br></div></h6>
  <p><p>Proxmox Backup Server (PBS) saved my bacon.</p>
<h2 id="backstory">Backstory</h2>
<p>I&rsquo;ve been using Proxmox VE (Virtual Edition) for a couple years and I&rsquo;ve been pretty pleased with it (<a href="/posts/230121_gns3_proxmox/">previous article on using it to run GNS3).  I run a virtualization server at home for a few reasons.  VMs have been a way to break apps out into seperate environments, making supporting self-hosting easier.  I think containers have made inroads here and many folks prefer them, but - no judgement - I&rsquo;ve always found VMs to be conceptually easier.  Second, I&rsquo;ve supported virtual environments and wanted to use my home network to get hands-on time.</p>
<p>Originally, I used a free version of VMWare (6.0 and later 6.5) but VMWare stopped supporting that version and it has never made sense to pay for an ESXi license for a home lab.  Proxmox  VE had a lot of the capabilities, plus the Linux underpinnings were much more obvious (which supported another direction I was heading).  The PVE environment has been mostly good and I&rsquo;ve never had an issue that I couldn&rsquo;t recover from (similar to what you&rsquo;d expect running ESXi).  Recently, however, I had a hard-drive fail in the RAID array.  That server was already pretty long in the tooth, so I built a new one.
<div class="admonition note">
    <div class="title">note</div>
    <div class="content">Proxmox includes a container technology that is interesting, but different from what someone familiar with docker might intuitively expect.  I&rsquo;ll get into that in a seperate post.  For purposes of this story, I&rsquo;m using &ldquo;vm&rdquo; but as many of my workloads as possible run as LXC containers.</div>
</div></p>
<h2 id="so-what-happened-was---">So what happened was . . .</h2>
<p>All good to this point, new server came up running PVE without a hitch.  I joined the servers together in a cluster and migrated VMs.  Most of my VMs, as mentioned, are single purpose appliances (either downloaded or assembled).  One of my VMs has a big disk file and is used to store my personal files.  And that&rsquo;s the one that wouldn&rsquo;t boot.</p>
<p>Because it&rsquo;s the biggest disk (by far), I migrated other workloads first.  I also upgraded my home network to 2.5G to support the environment, so I took a little longer to handle this VM.  My guess is that the VM suffered corruption, either running in a limping-RAID1 or during transfer.</p>
<h2 id="but-i-had-already---">But I had already . . .</h2>
<p>I setup PBS about six months ago and it had been backing up my VMs every week.  I did a recovery on a small VM way back, but hadn&rsquo;t really touched it since.  In this case, I was able to restore a copy of the impacted VM from a few days prior and recover all my files.  PBS runs in the background and emails me each week to let me know that it&rsquo;s good.  Recovery of a 2TB disk image did take a couple hours, but it was simple to setup.  If you use PVE, I think you have to use PBS.</p>
<h2 id="pbs-setup">PBS Setup</h2>
<p>Setting up PBS is about as difficult as setting up PVE.  If you did the one, the other will not be a problem.  The documentation is good, but takes some time to read so here&rsquo;s a quick walkthrough of the actions you&rsquo;ll need to take.</p>
<ol>
<li>Download and install PBS on a new machine.  I&rsquo;m using an old NUC with a 5TB drive.  <a href="https://www.proxmox.com/en/downloads">Download the image and throw it on <a href="/posts/210911_distrohoppingwventoy/">Ventoy!  This is an easy and obvious setup, so I won&rsquo;t walk you through clicking &ldquo;next&rdquo;.
<div class="admonition danger">
    <div class="title">Danger!</div>
    <div class="content">Don&rsquo;t install PBS on PVE!  If your Virtual enviroment fails, you don&rsquo;t want it to take backups with it!  If you don&rsquo;t have a suitable old PC, consider a 1L PC based on the modern Celeron like adding an NVME drive to this <a href="https://www.amazon.com/gp/product/B0BWZB8971/?th=1">Kikusenko.</div>
</div></li>
<li>When the process is complete, you can administer PBS from https://BACKUPSERVER:8007.  Login as root and the password you chose during setup.</li>
<li>Setup a Datastore on PBS.  &ldquo;Add Datastore&rdquo; is found under Datastore on the Proxmox menu.  This will make a local path available for backup use.</li>
</ol>
<p><img src="/240204_pbsdatastore.png#center" alt="PBS Datastore Setup"></p>
<ol start="4">
<li>
<p>Setup Pruning to keep the latest backups.  This setup mostly comes down to the crossing point of your budget, paranoia, and available space.  You can specify the number of backups to keep over various timeframes, such as days, weeks, months, and years.  I backup weekly and want to keep a couple backups, but I also keep monthlys as well in case I realize later that I need a restore.</p>
</li>
<li>
<p>Get the &ldquo;fingerprint&rdquo; using the big &ldquo;show Fingerprint&rdquo; button on the dashboard.</p>
</li>
</ol>
<h2 id="pve-setup-to-use-pbs">PVE Setup to use PBS</h2>
<p><img src="/240204_pbssetup.png#floatright" alt="PBS setup in PVE"></p>
<ol>
<li>
<p>Back in the PVE environment, go to the server view and select DataCenter &gt; Storage.</p>
</li>
<li>
<p>Click Add and choose Proxmox Backup Server from the drop-down menu.</p>
</li>
<li>
<p>Give the backup server an ID and enter in it&rsquo;s IP address.  Use <em>root@pam</em> as the username, the password you set on PBS and then supply the datastore setup in Step 3 above.  Here&rsquo;s where you&rsquo;ll need to paste in the fingerprint from PBS.  This is also the place where you can fiddle with retention and encryption if needed.</p>
</li>
</ol>
<h2 id="setup-backups">Setup Backups</h2>
<p><img src="/240204_automated_pbs.png#floatsmallleft" alt="PBS Job setup"></p>
<p>The simple way to backup a VM at this point is just to select a VM and choose &ldquo;Backup&rdquo;.  No one remembers to do backups though, so the key is to have them happen automatically.</p>
<ol>
<li>
<p>Still under Datacenter, choose backup and <strong>Add</strong>.</p>
</li>
<li>
<p>To backup all VMs from all PVE instances weekly, use the following settings:</p>
</li>
</ol>
<ul>
<li>Node <strong>&ndash;All &ndash;</strong></li>
<li>Storage <strong>pbs</strong></li>
<li>Schedule <strong>sun 01:00</strong></li>
<li>Selection: <strong>Include selected VMs</strong> or <strong>All</strong></li>
<li>Send email: <strong>Always</strong></li>
<li>Send email to:  <em>you@yourdomain.tld</em></li>
<li>Mode: <strong>Stop</strong></li>
</ul>
<h2 id="final-notes">Final Notes</h2>
<p>The process of setting this up isn&rsquo;t too confusing.  I find the Proxmox interface takes a little time to develop an intuitive feel, but this made sense.  At this point, weekly backups should start flowing in.  PBS will deduplicate and make very efficient use of space, so even a 4TB backup drive has been fine for me.</p>
<p>Restoring specific files or VMs is a topic for a second article.  Hope this is helpful!</p>
</p>
  <br>
  <hr>
  <h6>
    <strong>References:<br></strong> &nbsp&nbsp<a href=""><br> 
    
    
    <br>
    Recent articles related to these tags:
    
      
        <a href="/tags/backup/">backup 
       
        <a href="/tags/virtualization/">virtualization 
       
        <a href="/tags/linux/">linux 
       
    
    <ul style="list-style: none;">
      
      <li class="relatedPost">
        <a href="/posts/240324_ean/">Turning off Evolution Alarm Notify<br />
        
      </li>
    
      <li class="relatedPost">
        <a href="/posts/240226_newuser/">Adding a user to Ubuntu<br />
        How to add a user from BASH
      </li>
    
      <li class="relatedPost">
        <a href="/posts/240217_distro_hopping/">Distro Hopping<br />
        Again
      </li>
    
      <li class="relatedPost">
        <a href="/posts/240206_pbs_restore/">Restoring from Proxmox Backup Server<br />
        An easy way to protect your data
      </li>
    
      <li class="relatedPost">
        <a href="/posts/230819_nvidia535/">NVidia 5.35 Update<br />
        Update on NVidia 5.35
      </li>
    
  </ul>
<br>


    
Share this article:&NonBreakingSpace;
  <script src="https://platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
  <script type="IN/Share" data-url="/posts/240204_pbs/"></script>&NonBreakingSpace;
  <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</h6>
  <script
    async
    src="https://utteranc.es/client.js"
    repo="brentstewart/nextpertise"
    issue-term="title"
    theme="github-light"
    crossorigin="anonymous"></script>
  
    <div class="nav" style="position:fixed; color: white; background-color:lightgray; bottom:0px; text-align:center; width:100%">
     <nav class ="sidebar-nav"><a href="/">Proxmox Backup Server</nav>
</div>
  </body>
  </html>
